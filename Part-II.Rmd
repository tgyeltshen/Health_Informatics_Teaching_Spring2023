---
title: "Informatics Applied to Quantitative Data: Part-II (MPH Course: Health Informatics and Decision Making)"
author: "Zoie Shui-Yee Wong; Tshewang Gyeltshen"
#date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    toc_depth: '3'
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
    number_sections: no
    toc_depth: 3
    df_print: paged
    code_folding: hide
editor_options:
  chunk_output_type: console
  theme: flatly
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results="asis",warning = FALSE, message = FALSE) 
options(digits = 2)
library(ISLR) 
library(tidyverse)
library(corrplot)
library(car)
library(gtsummary)
```


# 1. Loading Data and Exploring the Data  

## Machine Learning Models for Binary Classification    
**$DatasetLASA.csv:$**  
The dataset $LASA$ contains free text tokens generated by NLP program (originally free text format and now structured as shown).  
The last column Y - "LASA" is the response variable and other columns are predictor variables, except column 1 (document ID).

LASA stands for look-alike and sound-alike medications.  
The response variable has been coded by two classes - 0: for Not LASA, and 1 for LASA.

Using 3 different machine learning models (including logistic regression, LDA and ANN) we will develop and evaluate classifiers to identify the classes using the structured (free-text) data.  

```{r}
rm(list = ls())
setwd("C:/Users/zoies/Desktop/StLuke_MicrosoftPC/Teaching/HI-2023/W8Handson")
dat <- read.csv("DatasetLASA.csv")
```

## Exploring the dataset
```{r}
#Explore the dataset, rename column name, set class names 
#head(dat)
class(dat)
colnames(dat)[1] <- 'DocID'
dat$LASAcases <- factor(dat$LASAcases, levels = c(0, 1), labels = c("NO", "YES")) 
# Change the class of LASA variable to factor for classification purpose.
dat$LASAcases[1:5]

```

# 2. Developing Machine Learning Models

## 2.1 Logistic Regression

```{r}
#Developing Logistic Regression model with binary response
glm_model <- glm(LASAcases ~ . -DocID, data = dat,family="binomial") 

#Predict the LASA cases based on LR
prob.error <- predict(glm_model,type='response')
lr.class<- rep("NO",227)     #227 (Assumed all to be 0, NO LASA cases)
lr.class[prob.error>.5] <- "YES"   #Change the ones greater than 0.5 to 1, i.e YES LASA cases 
lr.class[1:5] 

```


## 2.2 Liner Discriminant Analysis - LDA
Linear discriminant analysis `lda()` usage is basically similar to `lm()`, `glm()`. The MASS package needs to be loaded in advance.
```{r}
library(MASS)
# Fit the LDA model with all the predictor variables on the response variable LASA
lda_model = lda(LASAcases ~ .-DocID,data=dat) 

#Predict the LASA cases based on LDA
lda.pred <- predict(lda_model, dat)  
lda.class <- lda.pred$class
lda.class[1:5] 

```



## 2.3 Artifical Neural Network - ANN
```{r}
#install.packages(c('neuralnet'),dependencies = T)
library("neuralnet")
ann_model <- neuralnet(LASAcases ~. -DocID, data = dat, hidden = 1)
#You can control the hidden layers with 'hidden=' and simple ANN contains 1 hidden layer.

#Predict the LASA cases based on ANN
ann_pred <- predict(ann_model, dat) 
labels <- c("NO", "YES")
#The labels object is created as a character vector containing the labels for each category in the response variable (0= NO, 1 = YES).

ann.class <- data.frame(max.col(ann_pred)) %>%      
mutate(ann_pred=labels[max.col(ann_pred)]) %>% 
dplyr::select(2) %>% 
unlist() 
ann.class[1:5]

```

# 3. Evaluating Model Performance 
We will evaluate our model performances based on 2 by 2 confusion matrix and model evaluating metrics such as Precision, Recall, F-score, Accuracy, ROC and AUC.

## 3.1 Recall, Precision, F-1 score, and Accuracy 

```{r}
library(caret)
# Logistic regression model - evaluation
logit_cfnmtrx <- confusionMatrix(table(lr.class, dat$LASAcases))
logit_cfnmtrx$table
logit_cfnmtrx$byClass["Recall"]
logit_cfnmtrx$byClass["Precision"]
logit_cfnmtrx$byClass["F1"]
logit_cfnmtrx$overall["Accuracy"]

# LDA - evaluation
lda_cfnmtrx <- confusionMatrix(table(lda.class, dat$LASAcases))
lda_cfnmtrx$table
lda_cfnmtrx$byClass["Recall"]
lda_cfnmtrx$byClass["Precision"]
lda_cfnmtrx$byClass["F1"]
lda_cfnmtrx$overall["Accuracy"]

# ANN - evaluation
ann_cfnmtrx <- confusionMatrix(table(ann.class, dat$LASAcases))
ann_cfnmtrx$table
ann_cfnmtrx$byClass["Recall"]
ann_cfnmtrx$byClass["Precision"]
ann_cfnmtrx$byClass["F1"]
ann_cfnmtrx$overall["Accuracy"]

```

## 3.2 ROC Curves and AUC Values 
The `ROCR` and `pROC` packages are used for ROC curves.  
In order to draw the ROC curve, it is necessary to convert all outputs into probability values.  

```{r,fig.width=10,fig.height=5, fig.align='center'}
library(ROCR)
library(pROC)

# Extract the predicted probabilities for the positive class
logit0.pred <- predict(glm_model, dat, type = "response" )  # glm
lda0.pred <- predict(lda_model, dat)$posterior[,2]  # lda
ann.pred <- compute(ann_model, dat)$net.result
ann.pred <- ann.pred[, 1]

roc_logit <- roc(dat$LASAcases, logit0.pred)
roc_lda <- roc(dat$LASAcases, lda0.pred)
roc_ann <- roc(dat$LASAcases, ann.pred)

# Plot the ROC curve
par ( mfrow = c (2, 2 ) )
plot(roc_logit, main = "Logit") # GLM
plot(roc_lda, main = "LDA") # LDA
plot(roc_ann, main = "ANN") # ANN

#AUC - Area under the Curves 
auc(roc_logit)
auc(roc_lda)
auc(roc_ann)

```
